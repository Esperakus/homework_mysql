# Домашняя работа "MySQL - кластер"

Цель работы - с помощью terraform и ansible развернуть кластер PXC в Яндекс Облаке.

Данный репозиторий содержит:

- Манифесты terraform для создания инфраструктуры проекта:
   - 3 ноды кластера PXC
   - ВМ выполняющую роли ansible и джамп-хоста для доступа в локальную сеть проекта
- Роли ansible для приведения виртуальных машин в проекте в требуемое состояние.

При разворачивании стенда создаются ВМ с параметрами:
- 2 CPU;
- 2 GB RAM;
- 10 GB диск;
- операционная система CentOS 8 Stream;

Для разворачивания стенда необходимо:

1. В файле *variables.tf* заполнить значения переменных, необходимых для доступа к облаку Яндекс:
     - cloud-id (посмотреть в веб-консоли yandex cloud)
     - folder-id (посмотреть в веб-консоли yandex cloud)
     - iam-token (получить с помощью команды *$ yc iam create-token* )

2. Инициализировать рабочую среду Terraform:

```
$ terraform init
```
В результате будет установлен провайдер для подключения к облаку Яндекс.

3. Запустить разворачивание стенда:
```
$ terraform apply
```

В выходных данных будут показаны все внешние и внутренние ip адреса. Для проверки работы стенда необходимо зайти по ssh на джамп-хост, с которого, в свою очередь так же по ssh, можно попасть на ноды кластера pxc по их внутренним ip-адресам или hostname.

Для этого из рабочей папки проекта надо выполнить:

```
[homework_mysql]$ ssh cloud-user@{external_ip_address_ansible} -i id_rsa
```
**external_ip_address_ansible** можно посмотреть в выводе terraform или консоли yandex.cloud.

Доступ по ssh к нодам кластера PXC:

```
[cloud-user@ansible]$ ssh mysql-node0

[cloud-user@ansible]$ ssh mysql-node1

[cloud-user@ansible]$ ssh mysql-node2
```

Далее, с любой ноды кластера можно запустить консольного клиента mysql и проверить работоспособность кластера

```
[mysql-node0]$ mysql -uroot -p
Password: rootpwd!

mysql> show status like 'wsrep%';
```
В выводе будет видно состояние кластера:

```
| wsrep_cluster_size         | 3 
...
| wsrep_connected            | ON
...
| wsrep_ready                | ON 
```

В кластере развёрнута БД ***test*** и пользователь ***db_user*** (пароль **db_user_pwd**) с правами *'test.***:ALL'*.